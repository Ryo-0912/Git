各バージョンは、データ(ファイルの状態)をスナップショットで保存している

ローカルは、ワークツリー、ステージ、リポジトリの3つのエリアに分かれている
ワークツリー　: 手元の作業場

↓ ```git add```

ステージ : コミットする変更を準備する
コミット : スナップショットを記録すること

↓ ```git commit```

リポジトリ

git add前

```git diff```

git add後

```git diff --staged```

# git status

ステージに上げるべき変更とリポジトリに上げるべき変更を表示してくれる

# Gitのデータの管理の仕方

- Gitオブジェクト

git add や git commit した時、「圧縮ファイル」「ツリーファイル」「コミットファイル」が作成される。
Gitではこれらのファイルを「Gitオブジェクト」と呼んでいる。Gitオブジェクトは**「.git/objects」ディレクトリ**の下に保存されます。

この3つのGitオブジェクトについて。

***圧縮ファイル***

圧縮ファイルはファイルの中身そのものを圧縮したもの。正確には「blob（ブロブ）オブジェクト」。blobというのは「カタマリ」という意味。ファイルの中身を圧縮しただけのカタマリということになる。

圧縮ファイルのファイル名は**ハッシュID**となる。
ハッシュIDというのは、ヘッダー（ファイル内容の文字数など、ファイルのメタ情報）とファイル内容を、SHA-1というハッシュ関数で40文字の英数字に変換したもの。ハッシュIDのうち、先頭2文字をディレクトリ名に、残り38文字をファイル名にして保存する。

例

```
$ mkdir sample
 
# そのディレクトリに移動します
$ cd sample
 
# Gitを初期化します。ここまでは前準備です
$ git init
 
# ファイルの中身が「Hello, world!」というgreetingというファイルを作成します
$ echo 'Hello, world!' > greeting
 
# greetingのハッシュIDを表示します
$ git hash-object greeting
af5626b4a114abcb82d63db7c8082c3c4756e51b
このようにハッシュIDは、「af5626b4a114abcb82d63db7c8082c3c4756e51b」という40文字の英数字になります。

では次に git add して圧縮ファイルを作成してみましょう。

# git add することで圧縮ファイルを作成します
$ git add greeting
 
# .git以下のファイル構造を表示します。以下は今回関係している部分だけを抜粋
$ tree .git
.git
├─ objects
   ├─ af
      └─ 5626b4a114abcb82d63db7c8082c3c4756e51b
```

※ treeコマンドのインストール方法はこのレッスンの末尾に記載している。

圧縮ファイルは「.git/objects/af/5626b4a114abcb82d63db7c8082c3c4756e51b」として保存されている。

ここで重要なことは、ハッシュIDというのは、ファイルの中身に対して一意になる。中身が同じファイルであれば必ず同じハッシュIDになる。そのため、ファイルの中身が同じであれば git add しても追加で圧縮ファイルが作られることはなく、ファイルの中身に変更があれば git add すると別の圧縮ファイルが作成される。

***ツリーファイル***

圧縮ファイルは、ファイルの中身を圧縮したものを保存していて、圧縮ファイルのファイル名もファイルの中身をベースにハッシュ関数で作成されたもの,つまり、圧縮ファイルにはもともとのファイル名の情報がどこにも残っていない。

そこで、ファイル名とファイルの中身の組み合わせ（ファイル構造）を保存するためにあるのがツリーファイル。コミットをするとツリーファイルが作成される。ツリーファイルは「treeオブジェクト」と言う。

ツリーファイルは、ディレクトリの一つの階層ごとに一つのツリーファイルになっていて、ツリーファイルには圧縮ファイルだけでなくツリーファイルも保存されている。

例

なお、Gitオブジェクトの中身を確認するにはgit cat-file -p <オブジェクト名> （オブジェクト名はGitオブジェクトのハッシュIDやブランチ名など。詳細は公式ドキュメントのSPECIFYING REVISIONSを参照）コマンドを使用する。

```
# コミットしてツリーファイルを作成
$ git commit -m 'add greeting'
[master (root-commit) ae682f6] add greeting
 1 file changed, 1 insertion(+)
 create mode 100644 greeting
 
# master ブランチ上での最後のコミットが指しているツリーファイルの中身を表示
$ git cat-file -p master^{tree}
100644 blob af5626b4a114abcb82d63db7c8082c3c4756e51b    greeting
```

最後のコミットが指しているtreeには、blobオブジェクト「af5626b4a114abcb82d63db7c8082c3c4756e51b」が greeting というファイル名だ、ということが保存されている。

ここで、ディレクトリを追加してコミットしてみる。

```
$ mkdir subdir
 
# subdir ディレクトリの下に goodmorning というファイルを作成
$ echo 'Goodmorning!' > subdir/goodmorning
 
$ git add subdir
$ git commit -m 'add subdir'
[master 75458c8] add subdir
 1 file changed, 1 insertion(+)
 create mode 100644 subdir/goodmorning
 
# ツリーファイルのIDを取得するために、最後のコミットの中身を表示
# git cat-file -p master^{tree} コマンドでも大丈夫
$ git cat-file -p HEAD
tree acd75d1289b95787ecaab96c73fe1f3dbfa9cf67
parent ae682f61f39b5c364781cb179035ae534c56a326
author kiyodori <メールアドレス> 1493763216 +0900
committer kiyodori <メールアドレス> 1493763216 +0900
 
add subdir
 
# ツリーファイルの先頭の文字を指定して、ツリーファイルの中身を表示
$ git cat-file -p acd75d
100644 blob af5626b4a114abcb82d63db7c8082c3c4756e51b    greeting
040000 tree 60ac1b2d01e7f0c21178dcc2e767fb9a24d97124    subdir
blogオブジェクトに関してはさっきと同じです。そこに、treeオブジェクト「60ac1b2d01e7f0c21178dcc2e767fb9a24d97124」のツリー名は subdir だよ、というのが追加されている。
```

ここが注目ポイントで、ツリーファイルの中にツリーファイルが含まれていること。このように、ツリーファイルは一つのディレクトリに対応していて、ツリーファイルの中にツリーファイルと圧縮ファイルが含まれるようになっている。


図. ツリーファイルの構造

一応 subdir のツリーファイルの中身も確認。

```
# ツリーファイルの先頭の文字を指定して、ツリーファイルの中身を表示
$ git cat-file -p 60ac1b
100644 blob fa476f276a6fa984a789416f63f925e999834081    goodmorning
subdir ディレクトリには blobオブジェクト「fa476f276a6fa984a789416f63f925e999834081」がgoodmorning というファイル名で保存されている。
```

ここまでを振り替えると、一つのファイルに一つの圧縮ファイルが対応していて（※）、一つのディレクトリに一つのツリーファイルが対応していることがわかる。ツリーファイルは構造や名前を持たない圧縮ファイルに構造を与えるためのもので、圧縮ファイルやツリーファイルを保存している。

※ ファイルの中身が同じでファイル名が違う場合、圧縮ファイルはファイルの中身をベースに作成されるため、圧縮ファイルは同じものになる。

コミットファイル

ツリーファイルが作成されたことで、ファイルの構造がわかるようになった。しかしまだ、いつ、誰が、何を、何のために変更したのかということがわからない。

そこで、その情報を保存するためにあるのがコミットファイル。コミットファイルは正確には「commitオブジェクト」と言う。

```
# 最新のコミットファイルの中身を表示
$ git cat-file -p HEAD
tree acd75d1289b95787ecaab96c73fe1f3dbfa9cf67
parent ae682f61f39b5c364781cb179035ae534c56a326
author kiyodori <メールアドレス> 1493763216 +0900
committer kiyodori <メールアドレス> 1493763216 +0900
 
add subdir
```

まず、コミットした時点のtree「acd75d1289b95787ecaab96c73fe1f3dbfa9cf67」が保存されています。これはこのプロジェクトの一番上のディレクトリのツリーファイルになる。一番上の階層のツリーをコミットファイルに保存することで、コミットした時点でのスナップショットを記録している。

次がparent、親コミットを保存している。親コミットは「ae682f61f39b5c364781cb179035ae534c56a326」。Gitはこのように親コミットを保存することでコミットの履歴を辿れるようにしている。

あとは作成者の名前とメールアドレス、改行、コミットメッセージと続く。これで、変更者と変更理由がわかる。

<img width="564" alt="スクリーンショット 2024-04-03 11 52 49" src="https://github.com/Ryo-0912/Git/assets/82032550/6d8dad41-62b1-4173-9946-9af47c457166">


図. コミットファイルの構造

# まとめ

Gitは変更履歴を保存する時、圧縮ファイル、ツリーファイル、コミットファイルという形でスナップショットを記録している。
Gitの実体は基本的にはこれだけ。

Gitのコマンドは、この3つのGitオブジェクトに対して何らかの操作をしているだけ。
これから色々なコマンドを学んでいきます。その時、コマンドを闇雲に覚えるのではなく、このデータ構造に対してどういう操作をしているコマンドなのかということをイメージするといいかも。


※ treeコマンドのインストール方法
Macの場合

Homebrewを使ってインストールします。ターミナルで下記コマンドを実行してください。

$ brew install tree 
以上でtreeコマンドが使えるようになります。

※ 初回起動時にエラー文が表示されますが、問題ないため無視して大丈夫です。

これでtreeコマンドを使用できるようになります。



